---
title: "Consume Outputs"
author: "David Ory"
output: 
  html_document:
    theme: cosmo
    toc: yes
---


## Administration

#### Purpose
Consumes outputs from the Population Synthesizer. These procedures replace previous procedures done in SQL. A PUMS data dictionary is available [here](http://www2.census.gov/programs-surveys/acs/tech_docs/pums/data_dict/PUMSDataDict13.pdf).   

#### Outputs
1.  TBD

#### TODO
1. Everything, early days

## Procedure

#### Overhead
```{r overhead, results = 'hide'}
library(knitr)
suppressMessages(library(dplyr))
library(stringr)
suppressMessages(library(RMySQL))
suppressMessages(library(hydroGOF))
library(reshape2)
```

```{r config, include=FALSE}
knitr::opts_chunk$set(cache=TRUE)
```

#### Paramaters
```{r parameters}
MYSQL_SERVER    = "localhost"
MYSQL_DATABASE  = "pop_syn"
MYSQL_USER_NAME = "root" 

YEAR = "year_2010"

HH_INCOME_QUARTILE_THRESH_1 = 30000
HH_INCOME_QUARTILE_THRESH_2 = 60000
HH_INCOME_QUARTILE_THRESH_3 = 100000
```

#### Remote file locations
```{r remote-dir}
MYSQL_PASSWORD_FILE <- "C:/Users/dory/Desktop/mysql.csv"
F_OUTPUT <- paste("~/GitHub/popsyn3/validation/", YEAR, ".csv", sep = "")
```

#### Data reads
```{r data-reads}
# get password
mysql_passes <- read.csv(MYSQL_PASSWORD_FILE, header = TRUE)

mysql_passes <- mysql_passes %>%
  filter(user == MYSQL_USER_NAME) %>%
  mutate(pwd = paste(pwd))

# connection
mysql_connection <- dbConnect(MySQL(), user = MYSQL_USER_NAME, password = mysql_passes$pwd, host = MYSQL_SERVER, dbname = MYSQL_DATABASE)

# read the hh table
household_df <- dbReadTable(conn = mysql_connection, name = 'synpop_hh')
person_df <- dbReadTable(conn = mysql_connection, name = 'synpop_person')

# read in the controls for validation
maz_controls <-    dbReadTable(conn = mysql_connection, name = 'control_totals_maz')
taz_controls <-    dbReadTable(conn = mysql_connection, name = 'control_totals_taz')
county_controls <- dbReadTable(conn = mysql_connection, name = 'control_totals_meta')

dbDisconnect(mysql_connection)

```

#### MAZ for Controlled Measures
```{r maz-controls}
# maz controls: households
maz_validation <- maz_controls %>%
  select(maz, control_households = households) %>%
  mutate(measure = "households")

maz_synthezised <- household_df %>%
  group_by(maz) %>%
  summarise(synthesized_households = sum(finalweight))

maz_validation <- left_join(maz_validation, maz_synthezised, by = c("maz"))

# standardize variables to combine across geographies
maz_validation <- maz_validation %>%
  rename(geography_index = maz) %>%
  mutate(geography = "maz") %>%
  mutate(control_persons = NA) %>%
  mutate(synthesized_persons = NA) %>%
  mutate(measure_category = "Households")

remove(maz_synthezised)

```

#### TAZ for Controlled Measures
```{r taz-controls}
taz_validation <- taz_controls %>%
  select(taz, hh_income_quartile_1, hh_income_quartile_2, hh_income_quartile_3, hh_income_quartile_4)

taz_validation <- melt(taz_validation, id = c("taz"), variable.name = "measure", value.name = "control_households")

taz_validation <- taz_validation %>%
  mutate(measure = paste(measure))

taz_synthesized <- household_df %>%
  mutate(income_quartile = 0L) %>%
  mutate(income_quartile = ifelse(hh_income_2010 < HH_INCOME_QUARTILE_THRESH_1, 1L, income_quartile)) %>%
  mutate(income_quartile = ifelse(hh_income_2010 >= HH_INCOME_QUARTILE_THRESH_1 & hh_income_2010 < HH_INCOME_QUARTILE_THRESH_2, 2L, income_quartile)) %>%
  mutate(income_quartile = ifelse(hh_income_2010 >= HH_INCOME_QUARTILE_THRESH_2 & hh_income_2010 < HH_INCOME_QUARTILE_THRESH_3, 3L, income_quartile)) %>%
  mutate(income_quartile = ifelse(hh_income_2010 >= HH_INCOME_QUARTILE_THRESH_3, 4L, income_quartile)) %>%
  group_by(taz, income_quartile) %>%
  summarise(synthesized_households = sum(finalweight)) %>%
  mutate(measure = paste("hh_income_quartile", income_quartile, sep = "_")) %>%
  select(-income_quartile)

taz_validation <- left_join(taz_validation, taz_synthesized, by = c("taz", "measure"))  

# standardize variables to combine across geographies
taz_validation <- taz_validation %>%
  rename(geography_index = taz) %>%
  mutate(geography = "taz") %>%
  mutate(control_persons = NA) %>%
  mutate(synthesized_persons = NA) %>%
  mutate(measure_category = "Households by Income")

remove(taz_synthesized)

```

#### County for Controlled Measures
```{r county-controls}
# county controls: household size, household workers, age category, occupation category
county_validation <- melt(county_controls, id = c("county_name", "mtc_county_id"), variable.name = "measure", value.name = "households_or_persons")

county_validation <- county_validation %>%
  mutate(measure = paste(measure))

# household size
county_synthesized <- household_df %>%
  group_by(mtc_county_id, np) %>%
  summarise(synthesized_households = sum(finalweight)) %>%
  mutate(measure = "ERROR") %>%
  mutate(measure = ifelse(np == 1, "hh_size_1", measure)) %>%
  mutate(measure = ifelse(np == 2, "hh_size_2", measure)) %>%
  mutate(measure = ifelse(np == 3, "hh_size_3", measure)) %>%
  mutate(measure = ifelse(np > 3,  "hh_size_4_plus", measure)) %>%
  group_by(mtc_county_id, measure) %>%
  summarise(synthesized_households = sum(synthesized_households)) %>%
  mutate(measure_category_household = "Households by Number of People")

# household workers
working <- household_df %>%
  group_by(mtc_county_id, hh_workers_from_esr) %>%
  summarise(synthesized_households = sum(finalweight)) %>%
  mutate(measure = "ERROR") %>%
  mutate(measure = ifelse(hh_workers_from_esr == 0, "hh_workers_0", measure)) %>%
  mutate(measure = ifelse(hh_workers_from_esr == 1, "hh_workers_1", measure)) %>%
  mutate(measure = ifelse(hh_workers_from_esr == 2, "hh_workers_2", measure)) %>%
  mutate(measure = ifelse(hh_workers_from_esr > 2,  "hh_workers_3_plus", measure)) %>%
  group_by(mtc_county_id, measure) %>%
  summarise(synthesized_households = sum(synthesized_households)) %>%
  mutate(measure_category_household = "Households by Number of Workers")

county_synthesized <- rbind(county_synthesized, working)

# done with household level --> join
county_validation <- left_join(county_validation, county_synthesized, by = c("mtc_county_id", "measure"))

# persons by age category
county_synthesized <- person_df %>%
  group_by(mtc_county_id, agep) %>%
  summarise(synthesized_persons = sum(finalweight)) %>%
  mutate(measure = "ERROR") %>%
  mutate(measure = ifelse(agep <= 18, "age_00_18", measure)) %>%
  mutate(measure = ifelse(agep >= 19 & agep < 65, "age_19_64", measure)) %>%
  mutate(measure = ifelse(agep >= 65, "age_65_up", measure)) %>%
  group_by(mtc_county_id, measure) %>%
  summarise(synthesized_persons = sum(synthesized_persons)) %>%
  mutate(measure_category_person = "Persons by Age Category")

# persons by occupation
working <- person_df %>%
  group_by(mtc_county_id, occupation) %>%
  summarise(synthesized_persons = sum(finalweight)) %>%
  mutate(measure = "ERROR") %>%
  mutate(measure = ifelse(occupation == 1, "occupation_management", measure)) %>%
  mutate(measure = ifelse(occupation == 2, "occupation_professional", measure)) %>%
  mutate(measure = ifelse(occupation == 3, "occupation_services", measure)) %>%
  mutate(measure = ifelse(occupation == 4, "occupation_retail", measure)) %>%
  mutate(measure = ifelse(occupation == 5, "occupation_manual", measure)) %>%
  mutate(measure = ifelse(occupation == 6, "occupation_military", measure)) %>%
  group_by(mtc_county_id, measure) %>%
  summarise(synthesized_persons = sum(synthesized_persons)) %>%
  mutate(measure_category_person = "Persons by Occupation")

county_synthesized <- rbind(county_synthesized, working)

county_validation <- left_join(county_validation, county_synthesized, by = c("mtc_county_id", "measure"))

# standardize variables to combine across geographies
county_validation <- county_validation %>%
  rename(geography_index = mtc_county_id) %>%
  select(-county_name) %>%
  mutate(geography = "county") %>%
  mutate(control_households = ifelse(!is.na(synthesized_households), households_or_persons, NA)) %>%
  mutate(control_persons    = ifelse(!is.na(synthesized_persons),    households_or_persons, NA)) %>%
  mutate(measure_category   = ifelse(!is.na(synthesized_persons),    measure_category_person, measure_category_household)) %>%
  select(-households_or_persons, -measure_category_person, -measure_category_household)
           

remove(working, county_synthesized)
              
```

#### Write to disk
```{r data-writes}
validation_output <- rbind(maz_validation, taz_validation, county_validation)
write.csv(validation_output, file = F_OUTPUT, row.names = FALSE, quote = F)
```

# DEBUG

