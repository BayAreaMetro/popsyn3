---
title: "Prepare Inputs"
author: "David Ory"
output: 
  html_document:
    theme: cosmo
    toc: yes
---


## Administration

#### Purpose
Prepares inputs for the Population Synthesizer. These procedures replace previous procedures done in SQL.  

#### Outputs
1.  TBD (write everything to MySQL database)

#### TODO
1. Everything, early days
2. Rationalize all the variable and file names when things get working
3. See all the inline TODOs

## Procedure

#### Overhead
```{r overhead, results = 'hide'}
library(knitr)
suppressMessages(library(dplyr))
library(stringr)
suppressMessages(library(RMySQL))
```

```{r config, include=FALSE}
knitr::opts_chunk$set(cache=TRUE)
```

#### Paramaters
```{r parameters}
MYSQL_SERVER    = "localhost"
MYSQL_DATABASE  = "pop_syn"
MYSQL_USER_NAME = "root" 

YEAR = "2010"
```

#### Remote file locations
```{r remote-dir}
MYSQL_PASSWORD_FILE <- "C:/Users/dory/Desktop/mysql.csv"

CONTROL_DIR <- "C:/Users/dory/Box Sync/Travel Model Two Development/Demand/MTCPopSynIII/data"
PUMS_DIR <- "M:/Development/PopulationSynthesizer/PopSyn3/pums_data/acs2011_5yr/ca"

MAZ_CONTROL_FILE <-    paste(CONTROL_DIR, YEAR, "mazData.csv", sep = "/")
TAZ_CONTROL_FILE <-    paste(CONTROL_DIR, YEAR, "tazData.csv", sep = "/")
COUNTY_CONTROL_FILE <- paste(CONTROL_DIR, YEAR, "countyData_new.csv", sep = "/")
AGE_CONTROL_FILE <-    paste(CONTROL_DIR, YEAR, "personsByAge.csv", sep = "/")
GEOG_CONTROL_FILE <-   paste(CONTROL_DIR, "geographicCwalk.csv", sep = "/")

PUMS_HH_FILE <- paste(PUMS_DIR, "ss11hca.csv", sep = "/")
PUMS_PER_FILE <- paste(PUMS_DIR, "ss11pca.csv", sep = "/")

```

#### Data reads
```{r data-reads}
input_maz <- read.csv(MAZ_CONTROL_FILE, header = TRUE)
input_taz <- read.csv(TAZ_CONTROL_FILE, header = TRUE)
input_county <- read.csv(COUNTY_CONTROL_FILE, header = TRUE)
input_age <- read.csv(AGE_CONTROL_FILE, header = TRUE)
input_geog <- read.csv(GEOG_CONTROL_FILE, header = TRUE)

input_pums_hh <- read.csv(PUMS_HH_FILE, header = TRUE)
input_pums_per <- read.csv(PUMS_PER_FILE, header = TRUE)

```

#### Prepare MAZ controls
```{r prep-maz}
# TODO variable name has 2010 in it (fix using static column names?)
control_totals_maz <- input_maz %>%
  select(MAZ_ORIGINAL = MAZ, HH = X2010.HH)

# TODO make puma name more generic?
input_geog <- input_geog %>%
  rename(PUMA = PUMA5CE00)

control_totals_maz <- left_join(control_totals_maz, input_geog, by = c("MAZ_ORIGINAL"))

```

#### Prepare TAZ controls
```{r prep-taz}
control_totals_taz <- control_totals_maz %>%
  group_by(TAZ_ORIGINAL) %>%
  summarise(HH = sum(HH))

# create TAZ crosswalk, checking for PUMA and COUNTY overlaps
taz_geog <- input_geog %>%
  group_by(TAZ, TAZ_ORIGINAL, PUMA, COUNTYFP, MTCCountyID, COUNTYNAME) %>%
  summarise(count = n()) %>%
  select(-count)

check_taz_geog <- taz_geog %>%
  group_by(TAZ) %>%
  summarise(count = n()) %>%
  filter(count > 1)

control_totals_taz <- left_join(control_totals_taz, taz_geog, by = c("TAZ_ORIGINAL"))

# bring in income
# TODO what to do about these variable names?
to_join_taz <- input_taz %>%
  select(TAZ, HHINC1 = Less.than..30.000, HHINC2 = X.30.000.to..59.999, HHINC3 = X.60.000.to..99.999, HHINC4 = X.100.000.or.more)

control_totals_taz <- left_join(control_totals_taz, to_join_taz, by = c("TAZ"))

remove(taz_geog, to_join_taz)

```

#### Prepare County/Meta controls
```{r prep-county}
# TODO this references 2010 (fix using static column array)
control_totals_meta <- input_age %>%
  select(County, Age, persons = X2010.Persons.By.Age) %>%
  mutate(County = str_replace(County, " County", "")) %>%
  mutate(age_int = str_replace(Age, "\\+", "")) %>%
  mutate(age_int = str_replace(age_int, "Ages ", "")) %>%
  mutate(age_int = str_replace(age_int, "Age ", "")) %>%
  mutate(age_int = as.numeric(age_int)) %>%
  mutate(AGE0018 = ifelse(age_int < 19, persons, 0)) %>%
  mutate(AGE1964 = ifelse(age_int >= 19 & age_int < 65, persons, 0)) %>%
  mutate(AGE65PLUS = ifelse(age_int >= 65, persons, 0))

control_totals_meta <- control_totals_meta %>%
  group_by(County) %>%
  summarise(AGE0018 = sum(AGE0018), AGE1964 = sum(AGE1964), AGE65PLUS = sum(AGE65PLUS))

# create county crosswalk
county_names <- input_county %>%
  select(County_factor = COUNTYNAME, MTCCountyID) %>%
  mutate(County = paste(County_factor)) %>%
  select(-County_factor)

control_totals_meta <- left_join(control_totals_meta, county_names, by = c("County"))

# bring in hh size, hh workers, and occupation
# TODO variable names
to_join_meta <- input_county %>%
  select(MTCCountyID, 
         HHSIZE1 = X1.person.household, 
         HHSIZE2 = X2.person.household, 
         HHSIZE3 = X3.person.household, 
         HHSIZE4PLUS = X4.or.more.person.household,
         HHWORK0 = X0.workers, 
         HHWORK1 = X1.worker, 
         HHWORK2 = X2.workers, 
         HHWORK3PLUS = X3.or.more.workers,
         OCCP_Management = Management, 
         OCCP_Professional = Professional, 
         OCCP_Services = Services, 
         OCCP_Retail = Retail, 
         OCCP_Manual = Manual, 
         OCCP_Military = Military)

control_totals_meta <- left_join(control_totals_meta, to_join_meta, by = c("MTCCountyID"))

remove(county_names, to_join_meta)

```

#### Prepare PUMS data
```{r prep-pums}
# get list of relevant pums
relevant_pumas <- unique(input_geog$PUMA)

pums_hh  <- input_pums_hh[input_pums_hh$PUMA %in% relevant_pumas,]
pums_per <- input_pums_per[input_pums_per$PUMA %in% relevant_pumas,]

# remove vacant units and group quarters households
pums_hh <- pums_hh %>%
  filter(!(NP ==0)) %>%
  filter(TYPE <= 1)

# compute number of workers in the household
num_workers <- pums_per %>%
  mutate(workers = ifelse(ESR == 1 | ESR == 2 | ESR == 4 | ESR == 5, 1, 0)) %>%
  group_by(SERIALNO) %>%
  summarise(nwrkrs_esr = sum(workers))

pums_hh <- left_join(pums_hh, num_workers, by = c("SERIALNO"))

pums_hh <- pums_hh %>%
  mutate(nwrkrs_esr = ifelse(is.na(nwrkrs_esr), 0, nwrkrs_esr))

# put income in constant year dollars (TODO figure out where this came from, SQL says reported income * rolling reference factor * inflation adjustment)
pums_hh <- pums_hh %>%
  mutate(hhincAdj = 999) %>%
  mutate(hhincAdj = ifelse(ADJINC == 1102938, HINCP/1.0 * 1.016787 * 1.05156, hhincAdj)) %>%
  mutate(hhincAdj = ifelse(ADJINC == 1063801, HINCP/1.0 * 1.018389 * 1.01265, hhincAdj)) %>%
  mutate(hhincAdj = ifelse(ADJINC == 1048026, HINCP/1.0 * 0.999480 * 1.01651, hhincAdj)) %>%
  mutate(hhincAdj = ifelse(ADJINC == 1039407, HINCP/1.0 * 1.007624 * 1.00000, hhincAdj)) %>%
  mutate(hhincAdj = ifelse(ADJINC == 1018237, HINCP/1.0 * 1.018237 * 0.96942, hhincAdj))

# give each hh a more manageable unique id
hhnum <- 1:nrow(pums_hh)
pums_hh <- cbind(pums_hh, hhnum)
rownames(pums_hh) <- 1:nrow(pums_hh)

# set the initial person weight as the hh weight and give the person table the hhnum id
hh_weights <- pums_hh %>%
  select(SERIALNO, wgtp = WGTP, hhnum)

pums_per <- left_join(pums_per, hh_weights, by = c("SERIALNO"))

# use ESR to set employment dummy
pums_per <- pums_per %>%
  mutate(employed = ifelse(ESR == 1 | ESR == 2 | ESR == 4 | ESR == 5, 1, 0L))

# extract the occupation code
pums_per <- pums_per %>%
  mutate(soc = str_trim(socp00, side = c("both"))) %>%
  mutate(soc = ifelse(soc == "N.A.//", str_trim(socp10, side = c("both")), soc)) %>%
  mutate(soc = str_sub(soc, start = 1, end = 2)) %>%
  mutate(occp = 999) %>%
  mutate(occp = ifelse(soc == 11, 1, occp)) %>% # TODO check, SQL code says 'management'
  mutate(occp = ifelse(soc == 13 | soc == 15 | soc == 17 | soc == 19 | soc == 23 | soc == 25 | soc == 29, 2, occp)) %>% # 'professional'
  mutate(occp = ifelse(soc == 21 | soc == 27 | soc == 31 | soc == 33 | soc == 39 | soc == 43, 3, occp)) %>% # 'services'
  mutate(occp = ifelse(soc == 35 | soc == 41, 4, occp)) %>% # 'retail'
  mutate(occp = ifelse(soc == 37 | soc == 45 | soc == 47 | soc == 49 | soc == 51 | soc == 53 , 5, occp)) %>% # 'manual'
  mutate(occp = ifelse(soc == 55, 6, occp)) # 'military'

table(pums_per$occp)
table(pums_per$soc)

remove(hh_weights, num_workers, relevant_pumas)


```

#### Put data into MySQL database
```{r data-to-mysql}
# get password
mysql_passes <- read.csv(MYSQL_PASSWORD_FILE, header = TRUE)

mysql_passes <- mysql_passes %>%
  filter(user == MYSQL_USER_NAME) %>%
  mutate(pwd = paste(pwd))

# connection
mysql_connection <- dbConnect(MySQL(), user = MYSQL_USER_NAME, password = mysql_passes$pwd, host = MYSQL_SERVER, dbname = MYSQL_DATABASE)

# write the control tables
# TODO returns TRUE, do anything with it?
dbWriteTable(conn = mysql_connection, name = 'control_totals_maz',  value = as.data.frame(control_totals_maz),  overwrite = TRUE)
dbWriteTable(conn = mysql_connection, name = 'control_totals_taz',  value = as.data.frame(control_totals_taz),  overwrite = TRUE)
dbWriteTable(conn = mysql_connection, name = 'control_totals_meta', value = as.data.frame(control_totals_meta), overwrite = TRUE)

# write the household and person tables
dbWriteTable(conn = mysql_connection, name = 'hhtable',   value = as.data.frame(pums_hh),  overwrite = TRUE)
dbWriteTable(conn = mysql_connection, name = 'perstable', value = as.data.frame(pums_per), overwrite = TRUE)

dbDisconnect(mysql_connection)
```

