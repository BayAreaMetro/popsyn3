---
title: "Build Controls"
author: "David Ory"
output: 
  html_document:
    theme: cosmo
    toc: yes
---


## Administration

#### Purpose
Builds the control tables for the Population Synthesizer from Census data. The controls are then put into a MySQL database using `Prepare Inputs.Rmd`. The Java Population Synthesizer software then reads/writes to MySQL (see `go_go_popsyn.bat`). [Census API docs](http://api.census.gov/data.html). 

#### Outputs
1.  Year-specific control tables in CSV format

#### TODO
1. everything, early days
2. build all county controls here and try to do TAZ with blockgroup to TAZ correspondence

## Procedure

#### Overhead
```{r overhead, results = 'hide'}
library(knitr)

# devtools::install_github("hrecht/censusapi")
library(censusapi)

suppressMessages(library(dplyr))
```

```{r config, include=FALSE}
knitr::opts_chunk$set(cache=TRUE)
```

#### Paramaters
```{r parameters}
# year of the PUMS data
# PUMS_YEAR = "2007_2011"
# PUMS_YEAR = "2000"

# input data configured for 2000, 2005, and 2010
# YEAR = "year_2000"
# YEAR = "year_2005"
# YEAR = "year_2010"

STATE_FIPS = "06"
COUNTY_FIPS_STRING = "01,13,41,55,75,81,85,95,97"

county_codes <- data.frame(county_name = c("Alameda", "Contra Costa", "Marin", "Napa", "San Francisco", "San Mateo", "Santa Clara", "Solano", "Sonoma"),
                           county = c("001","013","041","055","075","081","085","095","097"), 
                           mtc_county_id = c(4,5,9,7,1,2,3,6,8),
                           stringsAsFactors = FALSE)

```

#### Remote file locations
```{r remote-dir}
CENSUS_API_KEY_FILE <- "C:/Users/dory/Desktop/census_api_key.csv"

CONTROL_DIR <- "M:/Development/PopulationSynthesizer/PopSyn3/_working/mysql_version/input_data"

# TODO add year 2000 pums to vector
# TODO where to get 2000 pums data as csv (iPums?)
PUMS_DIR <- c("M:/Development/PopulationSynthesizer/PopSyn3/pums_data/acs2011_5yr/ca")
PUMS_HH_FILE <- c(paste(PUMS_DIR, "ss11hca.csv", sep = "/"))
PUMS_PER_FILE <- c(paste(PUMS_DIR, "ss11pca.csv", sep = "/"))

```

```{r get-key}
api_key <- read.csv(CENSUS_API_KEY_FILE, header = TRUE)
api_key <- api_key %>%
  mutate(key = paste(key))
```


#### County Control: Households by size
```{r county-household-size}
# 2000: use decennial, SF1
raw_census <- getCensus(name = "sf1", 
                        vintage = 2000, 
                        key = api_key$key, 
                        vars=c("H013001", "H013002", "H013003", "H013004", "H013005", "H013006", "H013007", "H013008"), 
                        region = paste("county:", COUNTY_FIPS_STRING, sep = ""),
                        regionin = paste("state:", STATE_FIPS, sep = ""))

working <- left_join(raw_census, county_codes, by = c("county"))

household_size_df <- working %>%
  rename(hh_size_1 = H013002, hh_size_2 = H013003, hh_size_3 = H013004) %>%
  mutate(hh_size_4_plus = H013005 + H013006 + H013007 + H013008) %>%
  mutate(year = 2000) %>%
  select(year, county_name, mtc_county_id, hh_size_1, hh_size_2, hh_size_3, hh_size_4_plus)

# 2005
# the 2005 to 2009 estimate is availabe via API, the 2005 is not, but it is available via American Fact Finder: http://factfinder.census.gov/faces/tableservices/jsf/pages/productview.xhtml?pid=ACS_05_EST_B11016&prodType=table
# for now, enter manually
county_name = c("Alameda", "Contra Costa", "Marin", "Napa", "San Francisco", "San Mateo", "Santa Clara", "Solano", "Sonoma")
hh_size_1      = c(138023,  86591, 30247, 13619, 135391, 64287, 138519, 27870, 48213)
hh_size_2      = c(158682, 117955, 37125, 16347, 102717, 80142, 167536, 40804, 59038)
hh_size_3      = c( 84858,  62441, 14124,  6699,  37105, 43252, 101650, 25748, 28744)
hh_size_4_plus = c(139817,  95115, 20897, 11537,  47186, 66546, 172425, 40202, 41217)

working <- data.frame(county_name, hh_size_1, hh_size_2, hh_size_3, hh_size_4_plus, stringsAsFactors = FALSE)

working <- working %>%
  mutate(year = 2005)

working <- left_join(working, county_codes, by = c("county_name"))

working <- working %>%
  select(-county)

household_size_df <- rbind(household_size_df, working)


# 2010: use decennial, SF1, note that variable names are different than for 2000
raw_census <- getCensus(name = "sf1", 
                        vintage = 2010, 
                        key = api_key$key,
                        vars=c("H0130001", "H0130002", "H0130003", "H0130004", "H0130005", "H0130006", "H0130007", "H0130008"), 
                        region = paste("county:", COUNTY_FIPS_STRING, sep = ""),
                        regionin = paste("state:", STATE_FIPS, sep = ""))

working <- left_join(raw_census, county_codes, by = c("county"))

working <- working %>%
  rename(hh_size_1 = H0130002, hh_size_2 = H0130003, hh_size_3 = H0130004) %>%
  mutate(hh_size_4_plus = H0130005 + H0130006 + H0130007 + H0130008) %>%
  mutate(year = 2010) %>%
  select(year, county_name, mtc_county_id, hh_size_1, hh_size_2, hh_size_3, hh_size_4_plus)

household_size_df <- rbind(household_size_df, working)


```

#### County Control: Population
# TODO: how are group quarters handled?
```{r county-population}
# start here with H10. Total Population In Occupied Housing Units[1]
raw_census <- getCensus(name = "sf1", 
                        vintage = 2000, 
                        key = api_key$key, 
                        vars=c("H010001"), 
                        region = paste("county:", COUNTY_FIPS_STRING, sep = ""),
                        regionin = paste("state:", STATE_FIPS, sep = ""))


```

